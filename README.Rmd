---
output:
  md_document:
    variant: gfm
---


```{r setup, message = FALSE}
#devtools::install_github("thomazbastiaanssen/volatility")
library(tidyverse)
library(deleuze)
library(patchwork)
data = volatility::vola_genus_table$Validation_Pre_Control_2

data

```


```{r distributions}
#To do: estimate parameters of geometric mean distribution. 
hist(sampleGeomMeam(samples = 10000, count_sample = data))

#Notice that the zero-count features such as X13 have a much higher spread than high rollers like X7
sampleCLR(10000, data) %>%
  data.frame() %>%
  mutate(sample = as.character(1:10000)) %>%
  pivot_longer(!sample) %>%
  
  filter(name %in% paste0("X", 1:20)) %>%
  ggplot() +
  aes(x = value) +
  
  geom_histogram() +
  facet_wrap(~name, scales = "free") +
  theme_bw()


sampleCLRApprox(samples = 10000, data) %>%
  data.frame() %>%
  mutate(sample = as.character(1:10000)) %>%
  pivot_longer(!sample) %>%
  
  filter(name %in% paste0("X", 1:20)) %>%
  ggplot() +
  aes(x = value) +
  
  geom_histogram() +
  facet_wrap(~name, scales = "free") +
  theme_bw()

```


```{r estimation of the geometric mean}

#Mean can be estimated:
#observed
mean(sampleGeomMeam(samples = 10000, count_sample = data, log_transformed = T))
#estimated
mean(getBetaMeans(data, log_transformed = T))

#As can the standard deviation:
#observed
sd(sampleGeomMeam(samples = 10000, count_sample = data, log_transformed = T))
#estimated
#mean(sqrt(getBetaVars(data, log_transformed = T)))
sqrt(sum(getBetaVars(count_sample = data, log_transformed = T)) /  (length(data)* length(data)))


#comparing the distributions
#observed
par(mfrow=c(1,2))
hist(sampleGeomMeam(samples = 10000, count_sample = data, log_transformed = T), xlim =c(-9.2, -8))

#estimated
hist(sampleGeomMeanApprox(samples = 10000, count_sample = data, log_transformed = T), xlim =c(-9.2,  -8))


#Overlaid:
plot(density(sampleGeomMeam(samples = 10000, count_sample = data, log_transformed = T)), col = "red")

lines(density(sampleGeomMeanApprox(samples = 10000, count_sample = data, log_transformed = T)))


```

```{r comparing CLR to approx}
#real sampled data
a = sampleCLR(10000, data) %>%
  data.frame() %>%
  mutate(sample = as.character(1:10000)) %>%
  pivot_longer(!sample) %>%
  
  filter(name %in% paste0("X", 1:20)) %>%
  mutate(type = "sampled")

#sampled from approximationdevtools::
b = sampleCLRApprox(samples = 10000, data) %>%
  data.frame() %>%
  mutate(sample = as.character(1:10000)) %>%
  pivot_longer(!sample) %>%
  
  filter(name %in% paste0("X", 1:20)) %>%
  
  mutate(type = "approx")

rbind(a, b) %>%
  filter(name %in% paste0("X", 1:10)) %>%
  ggplot() +
  aes(x = value) +
  
  geom_histogram() +
  facet_grid(type~name, scales = "free") +
  theme_bw()

```

```{r benchmark}
library(microbenchmark)

mbm <- microbenchmark(
               "sample" = {
                 b <- sampleCLR(samples = 10000, data)
                 },
               "approx" = {
                 b <- sampleCLRApprox(samples = 10000, data)
                 })

mbm

```
